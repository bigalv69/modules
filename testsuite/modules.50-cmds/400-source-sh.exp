##############################################################################
#   Modules Revision 3.0
#   Providing a flexible user environment
#
#   File:		modules.50-cmds/%M%
#   Revision:		%I%
#   First Edition:	2020/05/20
#   Last Mod.:		%U%, %G%
#
#   Authors:		Xavier Delaruelle, xavier.delaruelle@cea.fr
#
#   Description:	Testuite testsequence
#   Command:
#   Modulefiles:    source-sh
#   Sub-Command:    *
#
#   Comment:	%C{
#           Check 'source-sh' modulefile command
#		}C%
#
##############################################################################

set mp $modpath.2
set mpre [regsub -all "\(\[.+?\]\)" $mp {\\\1}]

# setup specific environment
setenv_path_var MODULEPATH $mp

setenv_var TESTSUITE_SHTOMOD_PATHDUP 1
setenv_var TESTSUITE_SHTOMOD_NOCOMP 1


#
# load and unload tests
#

# basic load
set ans [list]
lappend ans [list set __MODULES_SHARE_FOOPATHDUPMIX ":1"]
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set FOOPATHDUP "/path/to/dir1:/path/to/dir2:/path/to/dir3:/path/to dir4"]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue]
lappend ans [list set FOOPATHEM :/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}]
lappend ans [list set __MODULES_SHARE_FOOPATHDUPEM :1]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }]
lappend ans [list set FOOPATHDUPMIX ":/path/to/dir1:/path/to/dir1 /path/to/dir2 /path/to/dir1:/path/to/dir3"]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set __MODULES_SHARE_FOOPATHEM :1]
lappend ans [list set FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3]
lappend ans [list set FOOPATHDUPEM :/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOO value]
lappend ans [list set FOOPATHDUPSP "/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to:dir4 /path/to/dir3"]
lappend ans [list set __MODULES_LMREFRESH source-sh/1]
lappend ans [list set FOOWC va\*ue]
lappend ans [list set FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo $(grep "report .Modules " ../../modulecmd.tcl | tr -d \\ 2>/dev/null | awk '{print $3}')}]
lappend ans [list alias alcb echo\ f\{o]
lappend ans [list alias alem {}]
lappend ans [list funcfoo "() { echo foo; };"]
lappend ans [list funccb "() { echo f\{o; };"]
lappend ans [list funcwc "() { echo sou*sh; };"]
lappend ans [list funcnl "() { echo foo;
    echo bar; };"]
lappend ans [list funcsp "() { echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o; };"]
lappend ans [list chdir $mp]

testouterr_cmd sh {load source-sh/1} $ans {}

# basic unload
setenv_loaded_module [list source-sh/1] [list $mp/source-sh/1]
setenv_var __MODULES_LMREFRESH source-sh/1
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue
setenv_path_var FOOPATHDUP "/path/to/dir1:/path/to/dir2:/path/to/dir3:/path/to dir4"
setenv_path_var FOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
setenv_path_var FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3
setenv_path_var FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3
setenv_path_var FOOPATHDUPMIX {} "/path/to/dir1:/path/to/dir1 /path/to/dir2 /path/to/dir1:/path/to/dir3"
setenv_path_var FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv_path_var FOOPATHDUPEM {} /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv_path_var FOOPATHDUPSP "/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to:dir4 /path/to/dir3"
setenv_var FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv_var FOOEM {}
setenv_var FOOSP {value }
setenv_var FOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }
setenv_var FOOCB va\{ue
setenv_var FOOWC va\*ue
setenv_var FOO value
setenv_var FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }

set ans [list]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPMIX]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset FOOPATHDUP]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPEM]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATHDUPSPEM]
lappend ans [list unset FOOPATHDUPMIX]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATH]
lappend ans [list unset __MODULES_SHARE_FOOPATHEM]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOOPATHDUPEM]
lappend ans [list unset FOO]
lappend ans [list unset FOOPATHDUPSP]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOWC]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unalias alsp]
lappend ans [list unalias alfoo]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list "unset -f funcfoo;"]
lappend ans [list "unset -f funccb;"]
lappend ans [list "unset -f funcwc;"]
lappend ans [list "unset -f funcnl;"]
lappend ans [list "unset -f funcsp;"]
testouterr_cmd sh {unload source-sh/1} $ans {}

skip_if_quick_mode

# load other modulefiles using source-sh
set ans [list]
lappend ans [list set FOOMINI value]
lappend ans [list set FOOPATH /path/to/mini:/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set __MODULES_LMREFRESH source-sh/1:source-sh/2]
lappend ans [list set _LMFILES_ $mp/source-sh/1:$mp/source-sh/2]
lappend ans [list set LOADEDMODULES source-sh/1:source-sh/2]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value]
lappend ans [list alias almini echo\ mini]
testouterr_cmd_re sh {load source-sh/2} $ans {}

# unload one of these modulefiles
setenv_loaded_module [list source-sh/1 source-sh/2] [list $mp/source-sh/1 $mp/source-sh/2]
setenv_var __MODULES_LMREFRESH source-sh/1:source-sh/2
setenv_var FOOMINI value
setenv_path_var FOOPATH /path/to/mini:/path/to/dir1:/path/to/dir2:/path/to/dir3
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value

set ans [list]
lappend ans [list unset FOOMINI]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set __MODULES_LMREFRESH source-sh/1]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue]
lappend ans [list unalias almini]
testouterr_cmd sh {unload source-sh/2} $ans {}

set ans [list]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPMIX]
lappend ans [list set _LMFILES_ $mp/source-sh/2]
lappend ans [list set LOADEDMODULES source-sh/2]
lappend ans [list unset FOOPATHDUP]
lappend ans [list set __MODULES_LMSOURCESH source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPEM]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATHDUPSPEM]
lappend ans [list unset FOOPATHDUPMIX]
lappend ans [list unset FOOCB]
lappend ans [list set FOOPATH /path/to/mini]
lappend ans [list unset __MODULES_SHARE_FOOPATHEM]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOOPATHDUPEM]
lappend ans [list unset FOO]
lappend ans [list unset FOOPATHDUPSP]
lappend ans [list set __MODULES_LMREFRESH source-sh/2]
lappend ans [list unset FOOWC]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unalias alsp]
lappend ans [list unalias alfoo]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list "unset -f funcfoo;"]
lappend ans [list "unset -f funccb;"]
lappend ans [list "unset -f funcwc;"]
lappend ans [list "unset -f funcnl;"]
lappend ans [list "unset -f funcsp;"]
testouterr_cmd sh {unload source-sh/1} $ans {}

# load a third modulefile, using same script than firstly loaded module
set ans [list]
lappend ans [list set FOOPATHDUPEM :/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3::/path/to/dir3]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPEM]
lappend ans [list set __MODULES_SHARE_FOOPATHDUPMIX ":2:/path/to/dir3:2"]
lappend ans [list set FOOPATHDUPMIX :/path/to/dir1:/path/to/dir1\ /path/to/dir2\ /path/to/dir1:/path/to/dir3]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set __MODULES_LMREFRESH source-sh/1:source-sh/2:source-sh/3]
lappend ans [list set _LMFILES_ $mp/source-sh/1:$mp/source-sh/2:$mp/source-sh/3]
lappend ans [list set LOADEDMODULES source-sh/1:source-sh/2:source-sh/3]
lappend ans [list set FOOPATHDUP "/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3:/path/to dir4:/path/to/dir3"]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value:source-sh/3\&bash\ testsuite/example/sh-to-mod.sh\|append-path\ FOOPATHDUPMIX\ /path/to/dir3\ \{\}\|chdir\ $mp\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOOPATH\ /path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir3\|setenv\ FOOPATHDUP\ \{/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>/path/to\ dir4\<EnvModEscPS\>/path/to/dir3\}\|setenv\ FOOPATHDUPEM\ \<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>\<EnvModEscPS\>/path/to/dir3]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo $(grep "report .Modules " ../../modulecmd.tcl | tr -d \\ 2>/dev/null | awk '{print $3}')}]
lappend ans [list alias alcb echo\ f\{o]
lappend ans [list alias alem {}]
lappend ans [list funcfoo "\\\(\\\) { echo foo; };"]
lappend ans [list funccb "\\\(\\\) { echo f\{o; };"]
lappend ans [list funcwc "\\\(\\\) { echo sou\\\*sh; };"]
lappend ans [list funcnl "\\\(\\\) { echo foo;
    echo bar; };"]
lappend ans [list funcsp "\\\(\\\) { echo f\\\\\"o;
    echo b\\\\\\\\\\\\\"r;
    echo f\\\\'o; };"]
lappend ans [list chdir $mpre]

testouterr_cmd_re sh {load source-sh/3} $ans {}

# unload from that point
setenv_loaded_module [list source-sh/1 source-sh/2 source-sh/3] [list $mp/source-sh/1 $mp/source-sh/2 $mp/source-sh/3]
setenv_var __MODULES_LMREFRESH source-sh/1:source-sh/2:source-sh/3
setenv_var FOOPATHDUP "/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3:/path/to dir4:/path/to/dir3"
unsetenv_var __MODULES_SHARE_FOOPATHDUPEM
unsetenv_var __MODULES_SHARE_FOOPATH
unsetenv_var __MODULES_SHARE_FOOPATHDUP
setenv_path_var FOOPATHDUPMIX :/path/to/dir1:/path/to/dir1\ /path/to/dir2\ /path/to/dir1:/path/to/dir3
setenv_var FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv_var FOOPATHDUPEM :/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3::/path/to/dir3
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value:source-sh/3\&bash\ testsuite/example/sh-to-mod.sh\|append-path\ FOOPATHDUPMIX\ /path/to/dir3\ \{\}\|chdir\ $mp\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOOPATH\ /path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir3\|setenv\ FOOPATHDUP\ \{/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>/path/to\ dir4\<EnvModEscPS\>/path/to/dir3\}\|setenv\ FOOPATHDUPEM\ \<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>\<EnvModEscPS\>/path/to/dir3

set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/2:$mp/source-sh/3]
lappend ans [list set LOADEDMODULES source-sh/2:source-sh/3]
lappend ans [list unset FOOPATHDUP]
lappend ans [list set __MODULES_LMSOURCESH source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value:source-sh/3\&bash\ testsuite/example/sh-to-mod.sh\|append-path\ FOOPATHDUPMIX\ /path/to/dir3\ \{\}\|chdir\ $mp\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOOPATH\ /path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir3\|setenv\ FOOPATHDUP\ \{/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>/path/to\ dir4\<EnvModEscPS\>/path/to/dir3\}\|setenv\ FOOPATHDUPEM\ \<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir2\<EnvModEscPS\>/path/to/dir1\<EnvModEscPS\>/path/to/dir3\<EnvModEscPS\>\<EnvModEscPS\>/path/to/dir3]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATHDUPSPEM]
lappend ans [list unset FOOPATHDUPMIX]
lappend ans [list unset FOOPATH]
lappend ans [list unset FOOCB]
lappend ans [list unset __MODULES_SHARE_FOOPATHEM]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOOPATHDUPEM]
lappend ans [list unset FOO]
lappend ans [list unset FOOPATHDUPSP]
lappend ans [list set __MODULES_LMREFRESH source-sh/2:source-sh/3]
lappend ans [list unset FOOWC]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unalias alsp]
lappend ans [list unalias alfoo]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list "unset -f funcfoo;"]
lappend ans [list "unset -f funccb;"]
lappend ans [list "unset -f funcwc;"]
lappend ans [list "unset -f funcnl;"]
lappend ans [list "unset -f funcsp;"]
testouterr_cmd_re sh {unload source-sh/1} $ans {}


#
# test other modes
#

# test 'list' sub-command
testouterr_cmd sh {list -t} OK $cur_loaded\nsource-sh/1\nsource-sh/2\nsource-sh/3

# test 'whatis' sub-command when some modules are loaded
testouterr_cmd_re sh {whatis source-sh} OK "$modlin $mpre $modlin
\\s*source-sh/1: source-sh/1
\\s*source-sh/2: source-sh/2
\\s*source-sh/3: source-sh/3
\\s*source-sh/4.0: source-sh/4.0
\\s*source-sh/4.1: source-sh/4.1
\\s*source-sh/4.2: source-sh/4.2
\\s*source-sh/4.3: source-sh/4.3
\\s*source-sh/6.0: source-sh/6.0
\\s*source-sh/7.0: source-sh/7.0
\\s*source-sh/7.1: source-sh/7.1
\\s*source-sh/7.2: source-sh/7.2"

# test 'help' sub-command when some modules are loaded
testouterr_cmd_re sh {help source-sh/1} OK "$modlin
Module Specific Help for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesHelp in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {help source-sh/4.3} OK "$modlin
Module Specific Help for $mpre/source-sh/4.3:

$warn_msgs: Unable to find ModulesHelp in $mpre/source-sh/4.3.
$modlin"

# test 'test' sub-command when some modules are loaded
testouterr_cmd_re sh {test source-sh/1} OK "$modlin
Module Specific Test for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesTest in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {test source-sh/4.3} OK "$modlin
Module Specific Test for $mpre/source-sh/4.3:

$warn_msgs: Unable to find ModulesTest in $mpre/source-sh/4.3.
$modlin"

# test 'display' sub-command when some modules are loaded
set tserr_disp1 "-------------------------------------------------------------------
$mp/source-sh/1:

chdir\t\t$mp
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHDUP /path/to/dir1 /path/to/dir2 /path/to/dir3 {/path/to dir4}
prepend-path\tFOOPATHDUPEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHDUPMIX {} /path/to/dir1 {/path/to/dir1 /path/to/dir2 /path/to/dir1} /path/to/dir3
prepend-path\tFOOPATHDUPSP {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to} {dir4 /path/to/dir3}
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/1
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/1} OK $tserr_disp1 xfail
} else {
    testouterr_cmd sh {display source-sh/1} OK $tserr_disp1
}
set tserr_disp2 "-------------------------------------------------------------------
$mp/source-sh/4.3:

[msg_moderr {Script 'testsuite/example/unk-to-mod.sh' cannot be found} {source-sh sh testsuite/example/unk-to-mod.sh} $mp/source-sh/4.3 2 {  }]
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/4.3} ERR $tserr_disp2
set tserr_disp3 "-------------------------------------------------------------------
$mp/source-sh/5.0:

append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
prepend-path	FOOPATH /path/to/mini
set-alias	almini {echo mini}
append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOOARG1 arg1
setenv		FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3
set tserr_disp4 "-------------------------------------------------------------------
$mp/source-sh/5.1:

append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOOARG1 arg1
setenv		FOOARG2 arg2
prepend-path	FOOPATH /path/to/mini
set-alias	almini {echo mini}
append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/5.1} OK $tserr_disp4


unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
unsetenv_path_var FOOPATHDUP
unsetenv_path_var FOOPATHEM
unsetenv_path_var FOOPATHCB
unsetenv_path_var FOOPATHWC
unsetenv_path_var FOOPATHDUPMIX
unsetenv_path_var FOOPATH
unsetenv_path_var FOOPATHDUPEM
unsetenv_path_var FOOPATHDUPSP
unsetenv_var FOOPATHSP
unsetenv_var FOOEM
unsetenv_var FOOSP
unsetenv_var FOOPATHDUPSPEM
unsetenv_var FOOCB
unsetenv_var FOOWC
unsetenv_var FOO
unsetenv_var FOOPATHSPEM
unsetenv_var FOOMINI

# test 'whatis' sub-command when no module loaded
testouterr_cmd_re sh {whatis source-sh} OK "$modlin $mpre $modlin
\\s*source-sh/1: source-sh/1
\\s*source-sh/2: source-sh/2
\\s*source-sh/3: source-sh/3
\\s*source-sh/4.0: source-sh/4.0
\\s*source-sh/4.1: source-sh/4.1
\\s*source-sh/4.2: source-sh/4.2
\\s*source-sh/4.3: source-sh/4.3
\\s*source-sh/7.0: source-sh/7.0
\\s*source-sh/7.1: source-sh/7.1
\\s*source-sh/7.2: source-sh/7.2"

# test 'help' sub-command when no module loaded
testouterr_cmd_re sh {help source-sh/1} OK "$modlin
Module Specific Help for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesHelp in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {help source-sh/4.3} OK "$modlin
Module Specific Help for $mpre/source-sh/4.3:

$warn_msgs: Unable to find ModulesHelp in $mpre/source-sh/4.3.
$modlin"

# test 'test' sub-command when no module loaded
testouterr_cmd_re sh {test source-sh/1} OK "$modlin
Module Specific Test for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesTest in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {test source-sh/4.3} OK "$modlin
Module Specific Test for $mpre/source-sh/4.3:

$warn_msgs: Unable to find ModulesTest in $mpre/source-sh/4.3.
$modlin"

# test 'display' sub-command when no module loaded
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/1} OK $tserr_disp1 xfail
} else {
    testouterr_cmd sh {display source-sh/1} OK $tserr_disp1
}
testouterr_cmd sh {display source-sh/4.3} ERR $tserr_disp2
set tserr_disp3 "-------------------------------------------------------------------
$mp/source-sh/5.0:

chdir		$mp
prepend-path	FOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHCB /path/to/dir1 /path/to/d{r2 /path/to/dir3
prepend-path	FOOPATHDUP /path/to/dir1 /path/to/dir2 /path/to/dir3 {/path/to dir4}
prepend-path	FOOPATHDUPEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHDUPMIX {} /path/to/dir1 {/path/to/dir1 /path/to/dir2 /path/to/dir1} /path/to/dir3
prepend-path	FOOPATHDUPSP {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to} {dir4 /path/to/dir3}
prepend-path	FOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHWC /path/to/dir1 /path/to/d*r2 /path/to/dir3
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOO value
setenv		FOOCB va{ue
setenv		FOOEM {}
setenv		FOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }
setenv		FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv		FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv		FOOSP {value }
setenv		FOOWC va*ue
prepend-path	FOOPATH /path/to/mini
set-alias	almini {echo mini}
setenv		FOOMINI value
append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOOARG1 arg1
setenv		FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv		FOOPATHDUP {/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3:/path/to dir4:/path/to/dir3}
setenv		FOOPATHDUPEM :/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3::/path/to/dir3
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3 xfail
} else {
    testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3
}
set tserr_disp4 "-------------------------------------------------------------------
$mp/source-sh/5.1:

chdir		$mp
prepend-path	FOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHCB /path/to/dir1 /path/to/d{r2 /path/to/dir3
prepend-path	FOOPATHDUP /path/to/dir1 /path/to/dir2 /path/to/dir3 {/path/to dir4}
prepend-path	FOOPATHDUPEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHDUPMIX {} /path/to/dir1 {/path/to/dir1 /path/to/dir2 /path/to/dir1} /path/to/dir3
prepend-path	FOOPATHDUPSP {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to} {dir4 /path/to/dir3}
prepend-path	FOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path	FOOPATHWC /path/to/dir1 /path/to/d*r2 /path/to/dir3
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOO value
setenv		FOOARG1 arg1
setenv		FOOARG2 arg2
setenv		FOOCB va{ue
setenv		FOOEM {}
setenv		FOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }
setenv		FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv		FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv		FOOSP {value }
setenv		FOOWC va*ue
prepend-path	FOOPATH /path/to/mini
set-alias	almini {echo mini}
setenv		FOOMINI value
append-path	FOOPATHDUPMIX /path/to/dir3 {}
chdir		$mp
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv		FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv		FOOPATHDUP {/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3:/path/to dir4:/path/to/dir3}
setenv		FOOPATHDUPEM :/path/to/dir1:/path/to/dir1:/path/to/dir2:/path/to/dir1:/path/to/dir3::/path/to/dir3
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/5.1} OK $tserr_disp4 xfail
} else {
    testouterr_cmd sh {display source-sh/5.1} OK $tserr_disp4
}

#
# erroneous call or script
#

# test bad source-sh call
if {[cmpversion $tclsh_version 8.6] == -1} {
    set msgtcl ...
} else {
    set msgtcl {?arg ...?}
}
set tserr "$moderr_msgs: wrong # args: should be \"source-sh shell script $msgtcl\"
    invoked from within
\"source-sh sh\"
    (file \"$mp/source-sh/4.0\" line 2)
$err_contactns"
testouterr_cmd sh {load source-sh/4.0} ERR [msg_load source-sh/4.0 $tserr]
set tserr "$moderr_msgs: wrong # args: should be \"source-sh shell script $msgtcl\"
    invoked from within
\"source-sh\"
    (file \"$mp/source-sh/4.1\" line 2)
$err_contactns"
testouterr_cmd sh {load source-sh/4.1} ERR [msg_load source-sh/4.1 $tserr]
set tserr [msg_moderr {Shell 'unk' not supported} {source-sh unk testsuite/example/sh-to-mod.sh} $mp/source-sh/4.2 2]
testouterr_cmd sh {load source-sh/4.2} ERR [msg_load source-sh/4.2 $tserr]
set tserr [msg_moderr {Script 'testsuite/example/unk-to-mod.sh' cannot be found} {source-sh sh testsuite/example/unk-to-mod.sh} $mp/source-sh/4.3 2]
testouterr_cmd sh {load source-sh/4.3} ERR [msg_load source-sh/4.3 $tserr]

# error during script evaluation
setenv_var TESTSUITE_SHTOMOD_FUZZYOUT1 1
set tserr [msg_moderr {Unexpected output when sourcing 'testsuite/example/sh-to-mod.sh' in shell 'bash'} {source-sh bash testsuite/example/sh-to-mod.sh} $mp/source-sh/1 2]
testouterr_cmd sh {load source-sh/1} ERR [msg_load source-sh/1 $tserr]


#
# empty script or duplicate source-sh calls
#

# test 'source-sh' script producing no output
unsetenv_var TESTSUITE_SHTOMOD_FUZZYOUT1
unsetenv_var TESTSUITE_SHTOMOD_PATHDUP
setenv_var TESTSUITE_SHTOMOD_NOVAR 1
setenv_var TESTSUITE_SHTOMOD_NOPATH 1
setenv_var TESTSUITE_SHTOMOD_NOALIAS 1
setenv_var TESTSUITE_SHTOMOD_NOFUNC 1
setenv_var TESTSUITE_SHTOMOD_NOCD 1
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|]
testouterr_cmd sh {load source-sh/1} $ans {}
set ans [list]
lappend ans [list set LOADEDMODULES source-sh/1:source-sh/2]
lappend ans [list set _LMFILES_ $mp/source-sh/1:$mp/source-sh/2]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value]
lappend ans [list setpath FOOPATH /path/to/mini:]
lappend ans [list set __MODULES_LMREFRESH source-sh/2]
lappend ans [list set FOOMINI value]
lappend ans [list alias almini echo\ mini]
testouterr_cmd_re sh {load source-sh/1 source-sh/2} $ans {}

setenv_loaded_module [list source-sh/1 source-sh/2] [list $mp/source-sh/1 $mp/source-sh/2]
setenv_var __MODULES_LMREFRESH source-sh/2
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|:source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/2]
lappend ans [list set LOADEDMODULES source-sh/2]
lappend ans [list set __MODULES_LMSOURCESH source-sh/2\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value]
testouterr_cmd sh {unload source-sh/1} $ans {}

unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
unsetenv_var TESTSUITE_SHTOMOD_NOVAR

set ans [list]
lappend ans [list set __MODULES_SHARE_FOOPATH :1]
lappend ans [list set FOOMINI value]
lappend ans [list set LOADEDMODULES source-sh/5.0]
lappend ans [list set _LMFILES_ $mp/source-sh/5.0]
lappend ans [list set __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOARG1 arg1]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set FOOPATH /path/to/mini:]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/5.0]
lappend ans [list set FOOWC va\*ue]
lappend ans [list alias almini echo\ mini]
testouterr_cmd sh {load source-sh/5.0} $ans {}

set ans [list]
lappend ans [list set __MODULES_SHARE_FOOPATH :1]
lappend ans [list set FOOMINI value]
lappend ans [list set LOADEDMODULES source-sh/5.1]
lappend ans [list set _LMFILES_ $mp/source-sh/5.1]
lappend ans [list set __MODULES_LMSOURCESH source-sh/5.1\&bash\ testsuite/example/sh-to-mod.sh\ arg1\ arg2\|setenv\ FOO\ value\|setenv\ FOOARG1\ arg1\|setenv\ FOOARG2\ arg2\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOARG1 arg1]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOARG2 arg2]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set FOOPATH /path/to/mini:]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/5.1]
lappend ans [list set FOOWC va\*ue]
lappend ans [list alias almini echo\ mini]
testouterr_cmd sh {load source-sh/5.1} $ans {}


#
# variable definition relying on a variable defined in sourced script
#

set tserr "-------------------------------------------------------------------
$mp/source-sh/6.0:

prepend-path	FOOPATH /path/to/mini {}
set-alias	almini {echo mini}
setenv		FOOMINI value
setenv		TS1 \$FOOMINI
setenv		TS2 value
module-whatis	source-sh/6.0
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/6.0} OK $tserr
set msgtcl "no such variable
      (read trace on \"env(FOOMINI)\")
      invoked from within"
set tserr "-------------------------------------------------------------------
Module Specific Help for $mp/source-sh/6.0:

Module ERROR: $msgtcl
  \"setenv TS2 \$env(FOOMINI)\"
      (file \"$mp/source-sh/6.0\" line 4)
  $err_contactns
-------------------------------------------------------------------"
testouterr_cmd sh {help source-sh/6.0} ERR $tserr
set tserr "-------------------------------------------------------------------
Module Specific Test for $mp/source-sh/6.0:

Module ERROR: $msgtcl
  \"setenv TS2 \$env(FOOMINI)\"
      (file \"$mp/source-sh/6.0\" line 4)
  $err_contactns
-------------------------------------------------------------------"
testouterr_cmd sh {test source-sh/6.0} ERR $tserr
testouterr_cmd sh {whatis source-sh/6.0} OK {}

# try evaluation with variable pre-defined
setenv_var FOOMINI value

set tserr "-------------------------------------------------------------------
$mp/source-sh/6.0:

prepend-path	FOOPATH /path/to/mini {}
set-alias	almini {echo mini}
setenv		TS1 \$FOOMINI
setenv		TS2 value
module-whatis	source-sh/6.0
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/6.0} OK $tserr
set tserr "-------------------------------------------------------------------
Module Specific Help for $mp/source-sh/6.0:

$warn_msgs: Unable to find ModulesHelp in $mp/source-sh/6.0.
-------------------------------------------------------------------"
testouterr_cmd sh {help source-sh/6.0} OK $tserr
set tserr "-------------------------------------------------------------------
Module Specific Test for $mp/source-sh/6.0:

$warn_msgs: Unable to find ModulesTest in $mp/source-sh/6.0.
-------------------------------------------------------------------"
testouterr_cmd sh {test source-sh/6.0} OK $tserr

set tserr "$modlin $mpre $modlin
\\s*source-sh/6.0: source-sh/6.0"
testouterr_cmd_re sh {whatis source-sh/6.0} OK $tserr

unsetenv_var FOOMINI


#
# inconsistent environment
#

# module loaded, but no __MODULES_LMSOURCESH
setenv_loaded_module [list source-sh/1] [list $mp/source-sh/1]
setenv_path_var FOOPATHDUP "/path/to/dir1:/path/to/dir2:/path/to/dir3:/path/to dir4"
setenv_path_var FOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
setenv_path_var FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3
setenv_path_var FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3
setenv_path_var FOOPATHDUPMIX {} /path/to/dir1 "/path/to/dir1 /path/to/dir2 /path/to/dir1" /path/to/dir3
setenv_path_var FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3
setenv_path_var FOOPATHDUPEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
setenv_path_var FOOPATHDUPSP "/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to:dir4 /path/to/dir3"
setenv_var FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv_var FOOEM {}
setenv_var FOOSP {value }
setenv_var FOOPATHDUPSPEM {/path/to/dir1 /path/to/dir1 /path/to/dir2 /path/to/dir1 /path/to/dir3 /path/to/dir3 }
setenv_var FOOCB va\{ue
setenv_var FOOWC va\*ue
setenv_var FOO value
setenv_var FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }

set ans [list]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
testouterr_cmd sh {unload source-sh/1} $ans {}

# partial __MODULES_LMSOURCESH
setenv_var __MODULES_LMREFRESH source-sh/1
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHDUP\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \{/path/to\ dir4\}\|prepend-path\ FOOPATHDUPEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHDUPMIX\ \{\}\ /path/to/dir1\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir1\}\ /path/to/dir3\|prepend-path\ FOOPATHDUPSP\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to\}\ \{dir4\ /path/to/dir3\}\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHDUPSPEM\ \{/path/to/dir1\ /path/to/dir1\ /path/to/dir2\ /path/to/dir1\ /path/to/dir3\ /path/to/dir3\ \}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOWC\ va\*ue
set ans [list]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPMIX]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset FOOPATHDUP]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset __MODULES_SHARE_FOOPATHDUPEM]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOPATHDUPSPEM]
lappend ans [list unset FOOPATHDUPMIX]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATH]
lappend ans [list unset __MODULES_SHARE_FOOPATHEM]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOOPATHDUPEM]
lappend ans [list unset FOO]
lappend ans [list unset FOOPATHDUPSP]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOWC]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unalias alsp]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list "unset -f funccb;"]
lappend ans [list "unset -f funcwc;"]
lappend ans [list "unset -f funcnl;"]
lappend ans [list "unset -f funcsp;"]
testouterr_cmd sh {unload source-sh/1} $ans {}

unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
unsetenv_path_var FOOPATHDUP
unsetenv_path_var FOOPATHEM
unsetenv_path_var FOOPATHCB
unsetenv_path_var FOOPATHWC
unsetenv_path_var FOOPATHDUPMIX
unsetenv_path_var FOOPATHDUPEM
unsetenv_path_var FOOPATHDUPSP
unsetenv_var FOOPATHSP
unsetenv_var FOOPATHDUPSPEM
unsetenv_var FOOPATHSPEM

# a LMSOURCESH entry with shtomodargs but no modcontent
setenv_loaded_module [list source-sh/5.0] [list $mp/source-sh/5.0]
setenv_var __MODULES_LMREFRESH source-sh/5.0
setenv_var FOOMINI value
setenv_var FOOARG1 arg1
setenv_path_var FOOPATH /path/to/mini {}
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1

set ans [list]
# re-serialized entry of __MODULES_LMSOURCESH is not equal to the one recorded in environment, so variable is not unset
lappend ans [list unset FOOMINI]
lappend ans [list unset __MODULES_SHARE_FOOPATH]
lappend ans [list unset FOOPATH]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list set __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1]
lappend ans [list unset FOOARG1]
lappend ans [list unalias almini]
testouterr_cmd sh {unload source-sh/5.0} $ans {}

setenv_var __MODULES_LMSOURCESH source-sh/5.0\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1
set ans [list]
lappend ans [list unset FOOMINI]
lappend ans [list unset __MODULES_SHARE_FOOPATH]
lappend ans [list unset FOOPATH]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOARG1]
lappend ans [list unalias almini]
testouterr_cmd sh {unload source-sh/5.0} $ans {}

# bad modulefile command call in __MODULES_LMSOURCESH (missing alias body arg)
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1
set ans [list]
# value set-alias and set-function is rewritten when parsed
lappend ans [list unset FOOMINI]
lappend ans [list unset __MODULES_SHARE_FOOPATH]
lappend ans [list unset FOOPATH]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list set __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1]
lappend ans [list unset FOOARG1]
lappend ans [list unalias almini]
testouterr_cmd sh {unload source-sh/5.0} $ans {}

# bad modulefile command call in __MODULES_LMSOURCESH (missing alias name and body args)
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1
set tserr "$moderr_msgs: wrong # args: should be \"set-alias alias what\"
    invoked from within
\"set-alias {}\"
    invoked from within
\"interp eval \$itrp \$modcmd\"
    (procedure \"source-sh-un\" line 17)
    invoked from within
\"source-sh sh testsuite/example/mini-sh-to-mod.sh\"
    (file \"$mp/source-sh/5.0\" line 3)
$err_contactns"
testouterr_cmd sh {unload source-sh/5.0} ERR [msg_unload source-sh/5.0 $tserr]

# bad modulefile command call in __MODULES_LMSOURCESH (missing variable value arg)
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1
set tserr "$moderr_msgs: wrong # args: should be \"setenv ?--set-if-undef? var val\"
    while executing
\"setenv FOOARG1\"
    invoked from within
\"interp eval \$itrp \$modcmd\"
    (procedure \"source-sh-un\" line 17)
    invoked from within
\"source-sh bash testsuite/example/sh-to-mod.sh arg1\"
    (file \"$mp/source-sh/5.0\" line 4)
$err_contactns"
testouterr_cmd sh {unload source-sh/5.0} ERR [msg_unload source-sh/5.0 $tserr]

# unknown modulefile command in __MODULES_LMSOURCESH
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-foo\ almini\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1
set tserr "$moderr_msgs: invalid command name \"set-foo\"
    while executing
\"set-foo almini\"
    invoked from within
\"interp eval \$itrp \$modcmd\"
    (procedure \"source-sh-un\" line 17)
    invoked from within
\"source-sh sh testsuite/example/mini-sh-to-mod.sh\"
    (file \"$mp/source-sh/5.0\" line 3)
$err_contactns"
testouterr_cmd sh {unload source-sh/5.0} ERR [msg_unload source-sh/5.0 $tserr]

# alias, function and completion defined in __MODULES_LMSOURCESH but not in script when modulefile is displayed
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOPATH\ /path/to/mini\ \{\}\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1|set-alias\ alunk\ \{\}\|set-function\ funcunk\ \{\}\|complete\ bash\ compunk\ \{\}
set tserr_disp3 "-------------------------------------------------------------------
$mp/source-sh/5.0:

setenv		FOO value
setenv		FOOCB va{ue
setenv		FOOEM {}
setenv		FOOSP {value }
setenv		FOOWC va*ue
prepend-path	FOOPATH /path/to/mini {}
set-alias	almini {echo mini}
setenv		FOOMINI value
setenv		FOOARG1 arg1
set-alias	alunk {}
set-function	funcunk {}
complete	bash compunk {}
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3 xfail
} else {
    testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3
}

# clear source-sh details recorded in env yet module is still loaded
unsetenv_var __MODULES_LMSOURCESH
set tserr_disp3 "-------------------------------------------------------------------
$mp/source-sh/5.0:

-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/5.0} OK $tserr_disp3


unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_path_var FOOPATH
unsetenv_var FOOEM
unsetenv_var FOOSP
unsetenv_var FOO
unsetenv_var FOOMINI
unsetenv_var FOOARG1
unsetenv_var FOOCB
unsetenv_var FOOWC


#
# escaping special chars
#

setenv_var TESTSUITE_SOURCESH_ESCCHAR 1

set ans [list]
lappend ans [list set __MODULES_SHARE_FOOPATH :1]
lappend ans [list set FOOMINI value]
lappend ans [list set _LMFILES_ $mp/source-sh/5.0]
lappend ans [list set LOADEDMODULES source-sh/5.0]
lappend ans [list set __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOESC\ \{\}\|prepend-path\ FOOPATH\ /path/\\\{\<EnvModEscS2\>\ /path/to/mini\ \{\}\ /path/\\\}\<EnvModEscS1\>\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOSP {value }]
lappend ans [list set __MODULES_SHARE_FOOESC :1]
lappend ans [list set FOOARG1 arg1]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set FOOPATH /path/\{\|:/path/to/mini::/path/\}\&]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/5.0]
lappend ans [list set FOOWC va\*ue]
lappend ans [list set FOOESC {}]
lappend ans [list alias almini echo\ mini]
testouterr_cmd sh {load source-sh/5.0} $ans {}

setenv_loaded_module [list source-sh/5.0] [list $mp/source-sh/5.0]
setenv_var __MODULES_LMREFRESH source-sh/5.0
setenv_var FOOMINI value
setenv_var FOOEM {}
setenv_var FOOSP {value }
setenv_var FOOARG1 arg1
setenv_var FOOCB va\{ue
setenv_var FOOWC va\*ue
setenv_path_var FOOPATH /path/\{\| /path/to/mini {} /path/\}\&
setenv_var FOO value
setenv_var __MODULES_LMSOURCESH source-sh/5.0\&bash\ testsuite/example/sh-to-mod.sh\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue\&sh\ testsuite/example/mini-sh-to-mod.sh\|prepend-path\ FOOESC\ \{\}\|prepend-path\ FOOPATH\ /path/\\\{\<EnvModEscS2\>\ /path/to/mini\ \{\}\ /path/\\\}\<EnvModEscS1\>\|set-alias\ almini\ \{\}\|setenv\ FOOMINI\ value\&bash\ testsuite/example/sh-to-mod.sh\ arg1\|setenv\ FOOARG1\ arg1
setenv_path_var FOOESC {}
set ans [list]
lappend ans [list unset __MODULES_SHARE_FOOPATH]
lappend ans [list unset FOOMINI]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOSP]
lappend ans [list unset __MODULES_SHARE_FOOESC]
lappend ans [list unset FOOARG1]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATH]
lappend ans [list unset FOO]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOWC]
lappend ans [list unset FOOESC]
lappend ans [list unalias almini]
testouterr_cmd sh {unload source-sh/5.0} $ans {}

unsetenv_loaded_module
unsetenv_var FOOMINI
unsetenv_var FOOEM
unsetenv_var FOOSP
unsetenv_var FOOARG1
unsetenv_var FOOCB
unsetenv_var FOOWC
unsetenv_path_var FOOPATH
unsetenv_var FOO
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
unsetenv_path_var FOOESC


# complete tests

unsetenv_var TESTSUITE_SHTOMOD_NOCOMP
unsetenv_var TESTSUITE_SHTOMOD_NOVAR
unsetenv_var TESTSUITE_SHTOMOD_NOPATH
unsetenv_var TESTSUITE_SHTOMOD_NOALIAS
unsetenv_var TESTSUITE_SHTOMOD_NOFUNC
unsetenv_var TESTSUITE_SHTOMOD_NOCD

# tcsh
if {[find_bin tcsh] ne {}} {
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/7.0]
lappend ans [list set LOADEDMODULES source-sh/7.0]
lappend ans [list set __MODULES_LMSOURCESH source-sh/7.0\&tcsh\ testsuite/example/sh-to-mod.csh\|chdir\ $mp\|complete\ tcsh\ cmd\ \{\}\|complete\ tcsh\ mycmd\ \{\}\|complete\ tcsh\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue]
lappend ans [list set FOOPATHEM :/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}]
lappend ans [list set FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set __MODULES_SHARE_FOOPATHEM :1]
lappend ans [list set FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/7.0]
lappend ans [list set FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }]
lappend ans [list set FOOWC va\*ue]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo `grep "report .Modules " ../../modulecmd.tcl | tr -d \\ | awk '{print $3}'`}]
lappend ans [list alias alcb echo\ f\\\{o]
lappend ans [list alias alem {}]
lappend ans [list out {complete cmd 'n/-h/n/' 'n/--help/n/' 'n/-V/n/' 'n/--version/n/' 'p/1/(-h -V --help --version)/';}]
lappend ans [list out {complete othercmd 'n/--help/n/';}]
lappend ans [list out {complete mycmd 'n/help/`_module_avail`/' 'n/add/`_module_not_yet_loaded; echo "--auto --no-auto --force -f --icase -i --tag --tag="`/';}]
lappend ans [list chdir $mp]
testouterr_cmd tcsh {load source-sh/7.0} $ans {}

set tserr_disp70 "-------------------------------------------------------------------
$mp/source-sh/7.0:

chdir\t\t$mp
complete\ttcsh cmd {'n/-h/n/' 'n/--help/n/' 'n/-V/n/' 'n/--version/n/' 'p/1/(-h -V --help --version)/'}
complete\ttcsh mycmd {'n/help/`_module_avail`/' 'n/add/`_module_not_yet_loaded; echo \"--auto --no-auto --force -f --icase -i --tag --tag=\"`/'}
complete\ttcsh othercmd 'n/--help/n/'
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
set-alias\talcb {echo f\\\{o}
set-alias\talem {}
set-alias\talfoo {echo `grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ | awk '{print \\\$3}'`}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.0
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/7.0} OK $tserr_disp70 xfail
    testouterr_cmd tcsh {display source-sh/7.0} OK $tserr_disp70 xfail
} else {
    testouterr_cmd sh {display source-sh/7.0} OK $tserr_disp70
    testouterr_cmd tcsh {display source-sh/7.0} OK $tserr_disp70
}

setenv_loaded_module [list source-sh/7.0] [list $mp/source-sh/7.0]
setenv_var __MODULES_LMREFRESH source-sh/7.0
setenv_var __MODULES_LMSOURCESH source-sh/7.0\&tcsh\ testsuite/example/sh-to-mod.csh\|chdir\ $mp\|complete\ tcsh\ cmd\ \{\}\|complete\ tcsh\ mycmd\ \{\}\|complete\ tcsh\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue
set ans [list]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATH]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOO]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unset FOOWC]
lappend ans [list unalias alsp]
lappend ans [list unalias alfoo]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list out {uncomplete cmd;}]
lappend ans [list out {uncomplete othercmd;}]
lappend ans [list out {uncomplete mycmd;}]
testouterr_cmd tcsh {unload source-sh/7.0} $ans {}

set ans [list]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo `grep "report .Modules " ../../modulecmd.tcl | tr -d \\ | awk '{print $3}'`}]
lappend ans [list alias alcb echo\ f\\\{o]
lappend ans [list alias alem {}]
lappend ans [list out {complete cmd 'n/-h/n/' 'n/--help/n/' 'n/-V/n/' 'n/--version/n/' 'p/1/(-h -V --help --version)/';}]
lappend ans [list out {complete othercmd 'n/--help/n/';}]
lappend ans [list out {complete mycmd 'n/help/`_module_avail`/' 'n/add/`_module_not_yet_loaded; echo "--auto --no-auto --force -f --icase -i --tag --tag="`/';}]
testouterr_cmd tcsh {refresh} $ans {}

# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd tcsh {display source-sh/7.0} OK $tserr_disp70 xfail
} else {
    testouterr_cmd tcsh {display source-sh/7.0} OK $tserr_disp70
}

unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
}

# bash
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/7.1]
lappend ans [list set LOADEDMODULES source-sh/7.1]
lappend ans [list set __MODULES_LMSOURCESH source-sh/7.1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|complete\ bash\ cmd\ \{\}\|complete\ bash\ mycmd\ \{\}\|complete\ bash\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue]
lappend ans [list set FOOPATHEM :/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}]
lappend ans [list set FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set __MODULES_SHARE_FOOPATHEM :1]
lappend ans [list set FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/7.1]
lappend ans [list set FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }]
lappend ans [list set FOOWC va\*ue]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo $(grep "report .Modules " ../../modulecmd.tcl | tr -d \\ 2>/dev/null | awk '{print $3}')}]
lappend ans [list alias alcb echo\ f\{o]
lappend ans [list alias alem {}]
lappend ans [list funcfoo "() { echo foo; }; export -f funcfoo;"]
lappend ans [list funccb "() { echo f\{o; }; export -f funccb;"]
lappend ans [list funcwc "() { echo sou*sh; }; export -f funcwc;"]
lappend ans [list funcnl "() { echo foo;
    echo bar; }; export -f funcnl;"]
lappend ans [list funcsp "() { echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o; }; export -f funcsp;"]
lappend ans [list out {complete -o default -F _cmd cmd;}]
lappend ans [list out {complete -u othercmd;}]
lappend ans [list out {complete -j -P '"%' -S '"' mycmd;}]
lappend ans [list chdir $mp]
testouterr_cmd bash {load source-sh/7.1} $ans {}

set tserr_disp71 "-------------------------------------------------------------------
$mp/source-sh/7.1:

chdir\t\t$mp
complete\tbash cmd {-o default -F _cmd}
complete\tbash mycmd {-j -P '\"%' -S '\"'}
complete\tbash othercmd -u
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
set-alias\talcb {echo\ f\{o}
set-alias\talem {}
set-alias\talfoo {echo \$(grep \"report .Modules \" ../../modulecmd.tcl | tr -d \\\\ 2>/dev/null | awk '\{print \$3\}')}
set-alias\talsp {echo f\\\"o; echo b\\\\\\\"r; echo f\\'o}
set-function\tfunccb {
    echo f\{o}
set-function\tfuncfoo {
    echo foo}
set-function\tfuncnl {
    echo foo;
    echo bar}
set-function\tfuncsp {
    echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o}
set-function\tfuncwc {
    echo sou*sh}
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.1
-------------------------------------------------------------------"
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/7.1} OK $tserr_disp71 xfail
    testouterr_cmd bash {display source-sh/7.1} OK $tserr_disp71 xfail
} else {
    testouterr_cmd sh {display source-sh/7.1} OK $tserr_disp71
    testouterr_cmd bash {display source-sh/7.1} OK $tserr_disp71
}

setenv_loaded_module [list source-sh/7.1] [list $mp/source-sh/7.1]
setenv_var __MODULES_LMREFRESH source-sh/7.1
setenv_var __MODULES_LMSOURCESH source-sh/7.1\&bash\ testsuite/example/sh-to-mod.sh\|chdir\ $mp\|complete\ bash\ cmd\ \{\}\|complete\ bash\ mycmd\ \{\}\|complete\ bash\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|set-alias\ alcb\ \{\}\|set-alias\ alem\ \{\}\|set-alias\ alfoo\ \{\}\|set-alias\ alsp\ \{\}\|set-function\ funccb\ \{\}\|set-function\ funcfoo\ \{\}\|set-function\ funcnl\ \{\}\|set-function\ funcsp\ \{\}\|set-function\ funcwc\ \{\}\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue
set ans [list]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATH]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOO]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unset FOOWC]
lappend ans [list unalias alsp]
lappend ans [list unalias alfoo]
lappend ans [list unalias alcb]
lappend ans [list unalias alem]
lappend ans [list out {unset -f funcfoo;}]
lappend ans [list out {unset -f funccb;}]
lappend ans [list out {unset -f funcwc;}]
lappend ans [list out {unset -f funcnl;}]
lappend ans [list out {unset -f funcsp;}]
lappend ans [list out {complete -r cmd;}]
lappend ans [list out {complete -r othercmd;}]
lappend ans [list out {complete -r mycmd;}]
testouterr_cmd bash {unload source-sh/7.1} $ans {}

set ans [list]
lappend ans [list alias alsp {echo f\"o; echo b\\\"r; echo f\'o}]
lappend ans [list alias alfoo {echo $(grep "report .Modules " ../../modulecmd.tcl | tr -d \\ 2>/dev/null | awk '{print $3}')}]
lappend ans [list alias alcb echo\ f\{o]
lappend ans [list alias alem {}]
lappend ans [list funcfoo "() { echo foo; }; export -f funcfoo;"]
lappend ans [list funccb "() { echo f\{o; }; export -f funccb;"]
lappend ans [list funcwc "() { echo sou*sh; }; export -f funcwc;"]
lappend ans [list funcnl "() { echo foo;
    echo bar; }; export -f funcnl;"]
lappend ans [list funcsp "() { echo f\\\"o;
    echo b\\\\\\\"r;
    echo f\\'o; }; export -f funcsp;"]
lappend ans [list out {complete -o default -F _cmd cmd;}]
lappend ans [list out {complete -u othercmd;}]
lappend ans [list out {complete -j -P '"%' -S '"' mycmd;}]
testouterr_cmd bash {refresh} $ans {}

# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd bash {display source-sh/7.1} OK $tserr_disp71 xfail
} else {
    testouterr_cmd bash {display source-sh/7.1} OK $tserr_disp71
}

unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH

setenv_var TESTSUITE_SHTOMOD_NOALIAS 1
setenv_var TESTSUITE_SHTOMOD_NOFUNC 1

# fish
if {[find_bin fish] ne {}} {
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/7.2]
lappend ans [list set LOADEDMODULES source-sh/7.2]
lappend ans [list set __MODULES_LMSOURCESH source-sh/7.2\&fish\ testsuite/example/sh-to-mod.fish\|chdir\ $mp\|complete\ fish\ cmd\ \{\}\|complete\ fish\ mycmd\ \{\}\|complete\ fish\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue]
lappend ans [list set FOOPATHEM :/path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}]
lappend ans [list set FOOPATHCB /path/to/dir1:/path/to/d\{r2:/path/to/dir3]
lappend ans [list set FOOEM {}]
lappend ans [list set FOOSP {value }]
lappend ans [list set FOOPATH /path/to/dir1:/path/to/dir2:/path/to/dir3]
lappend ans [list set FOOCB va\{ue]
lappend ans [list set __MODULES_SHARE_FOOPATHEM :1]
lappend ans [list set FOOPATHWC /path/to/dir1:/path/to/d\*r2:/path/to/dir3]
lappend ans [list set FOO value]
lappend ans [list set __MODULES_LMREFRESH source-sh/7.2]
lappend ans [list set FOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }]
lappend ans [list set FOOWC va\*ue]
if {[info exists fish_version_ge31] && $fish_version_ge31} {
lappend ans [list out {complete -e -c cmd;}]
lappend ans [list out {complete -c cmd -l help -d 'Command help';}]
lappend ans [list out {complete -c cmd -l version -d 'Command version';}]
lappend ans [list out {complete -c cmd -s h -d 'Command help';}]
lappend ans [list out {complete -c cmd -s V -d 'Command version';}]
lappend ans [list out {complete -e -c othercmd;}]
lappend ans [list out {complete -c othercmd --no-files -l help -d 'Command help';}]
lappend ans [list out {complete -c othercmd --no-files -s h -d 'Command help';}]
lappend ans [list out {complete -c othercmd -l version -d 'Command version';}]
lappend ans [list out {complete -c othercmd -s V -d 'Command version';}]
lappend ans [list out {complete -e -c mycmd;}]
lappend ans [list out {complete -c mycmd --exclusive -s h -d 'Command help';}]
} else {
lappend ans [list out {complete -e -c cmd;}]
lappend ans [list out {complete -c cmd --long-option help --description 'Command help';}]
lappend ans [list out {complete -c cmd --long-option version --description 'Command version';}]
lappend ans [list out {complete -c cmd --short-option 'h' --description 'Command help';}]
lappend ans [list out {complete -c cmd --short-option 'V' --description 'Command version';}]
lappend ans [list out {complete -e -c othercmd;}]
lappend ans [list out {complete -c othercmd --long-option version --description 'Command version';}]
lappend ans [list out {complete -c othercmd --no-files --long-option help --description 'Command help';}]
lappend ans [list out {complete -c othercmd --no-files --short-option 'h' --description 'Command help';}]
lappend ans [list out {complete -c othercmd --short-option 'V' --description 'Command version';}]
lappend ans [list out {complete -e -c mycmd;}]
lappend ans [list out {complete -c mycmd --exclusive --short-option 'h' --description 'Command help';}]
}
lappend ans [list chdir $mp]
testouterr_cmd fish {load source-sh/7.2} $ans {}

if {[info exists fish_version_ge31] && $fish_version_ge31} {
set tserr_disp72 "-------------------------------------------------------------------
$mp/source-sh/7.2:

chdir\t\t$mp
complete\tfish cmd {-l help -d 'Command help'}
complete\tfish cmd {-l version -d 'Command version'}
complete\tfish cmd {-s h -d 'Command help'}
complete\tfish cmd {-s V -d 'Command version'}
complete\tfish mycmd {--exclusive -s h -d 'Command help'}
complete\tfish othercmd {--no-files -l help -d 'Command help'}
complete\tfish othercmd {--no-files -s h -d 'Command help'}
complete\tfish othercmd {-l version -d 'Command version'}
complete\tfish othercmd {-s V -d 'Command version'}
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.2
-------------------------------------------------------------------"
} else {
set tserr_disp72 "-------------------------------------------------------------------
$mp/source-sh/7.2:

chdir\t\t$mp
complete\tfish cmd {--long-option help --description 'Command help'}
complete\tfish cmd {--long-option version --description 'Command version'}
complete\tfish cmd {--short-option 'h' --description 'Command help'}
complete\tfish cmd {--short-option 'V' --description 'Command version'}
complete\tfish mycmd {--exclusive --short-option 'h' --description 'Command help'}
complete\tfish othercmd {--long-option version --description 'Command version'}
complete\tfish othercmd {--no-files --long-option help --description 'Command help'}
complete\tfish othercmd {--no-files --short-option 'h' --description 'Command help'}
complete\tfish othercmd {--short-option 'V' --description 'Command version'}
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.2
-------------------------------------------------------------------"
}
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd sh {display source-sh/7.2} OK $tserr_disp72 xfail
    testouterr_cmd fish {display source-sh/7.2} OK $tserr_disp72 xfail
} else {
    testouterr_cmd sh {display source-sh/7.2} OK $tserr_disp72
    testouterr_cmd fish {display source-sh/7.2} OK $tserr_disp72
}

setenv_loaded_module [list source-sh/7.2] [list $mp/source-sh/7.2]
setenv_var __MODULES_LMREFRESH source-sh/7.2
setenv_var __MODULES_LMSOURCESH source-sh/7.2\&fish\ testsuite/example/sh-to-mod.fish\|chdir\ $mp\|complete\ fish\ cmd\ \{\}\|complete\ fish\ mycmd\ \{\}\|complete\ fish\ othercmd\ \{\}\|prepend-path\ FOOPATH\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHCB\ /path/to/dir1\ /path/to/d\\\{r2\ /path/to/dir3\|prepend-path\ FOOPATHEM\ \{\}\ /path/to/dir1\ /path/to/dir2\ /path/to/dir3\|prepend-path\ FOOPATHWC\ /path/to/dir1\ /path/to/d\*r2\ /path/to/dir3\|setenv\ FOO\ value\|setenv\ FOOCB\ va\\\{ue\|setenv\ FOOEM\ \{\}\|setenv\ FOOPATHSP\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\}\|setenv\ FOOPATHSPEM\ \{/path/to/dir1\ /path/to/dir2\ /path/to/dir3\ \}\|setenv\ FOOSP\ \{value\ \}\|setenv\ FOOWC\ va\*ue
set ans [list]
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset __MODULES_LMSOURCESH]
lappend ans [list unset FOOPATHEM]
lappend ans [list unset FOOPATHSP]
lappend ans [list unset FOOPATHCB]
lappend ans [list unset FOOEM]
lappend ans [list unset FOOSP]
lappend ans [list unset FOOPATH]
lappend ans [list unset FOOCB]
lappend ans [list unset FOOPATHWC]
lappend ans [list unset FOO]
lappend ans [list unset __MODULES_LMREFRESH]
lappend ans [list unset FOOPATHSPEM]
lappend ans [list unset FOOWC]
lappend ans [list out {complete -e -c cmd;}]
lappend ans [list out {complete -e -c othercmd;}]
lappend ans [list out {complete -e -c mycmd;}]
testouterr_cmd fish {unload source-sh/7.2} $ans {}

set ans [list]
if {[info exists fish_version_ge31] && $fish_version_ge31} {
lappend ans [list out {complete -e -c cmd;}]
lappend ans [list out {complete -c cmd -l help -d 'Command help';}]
lappend ans [list out {complete -c cmd -l version -d 'Command version';}]
lappend ans [list out {complete -c cmd -s h -d 'Command help';}]
lappend ans [list out {complete -c cmd -s V -d 'Command version';}]
lappend ans [list out {complete -e -c othercmd;}]
lappend ans [list out {complete -c othercmd --no-files -l help -d 'Command help';}]
lappend ans [list out {complete -c othercmd --no-files -s h -d 'Command help';}]
lappend ans [list out {complete -c othercmd -l version -d 'Command version';}]
lappend ans [list out {complete -c othercmd -s V -d 'Command version';}]
lappend ans [list out {complete -e -c mycmd;}]
lappend ans [list out {complete -c mycmd --exclusive -s h -d 'Command help';}]
} else {
lappend ans [list out {complete -e -c cmd;}]
lappend ans [list out {complete -c cmd --long-option help --description 'Command help';}]
lappend ans [list out {complete -c cmd --long-option version --description 'Command version';}]
lappend ans [list out {complete -c cmd --short-option 'h' --description 'Command help';}]
lappend ans [list out {complete -c cmd --short-option 'V' --description 'Command version';}]
lappend ans [list out {complete -e -c othercmd;}]
lappend ans [list out {complete -c othercmd --long-option version --description 'Command version';}]
lappend ans [list out {complete -c othercmd --no-files --long-option help --description 'Command help';}]
lappend ans [list out {complete -c othercmd --no-files --short-option 'h' --description 'Command help';}]
lappend ans [list out {complete -c othercmd --short-option 'V' --description 'Command version';}]
lappend ans [list out {complete -e -c mycmd;}]
lappend ans [list out {complete -c mycmd --exclusive --short-option 'h' --description 'Command help';}]
}
testouterr_cmd fish {refresh} $ans {}

if {[info exists fish_version_ge31] && $fish_version_ge31} {
set tserr_disp72 "-------------------------------------------------------------------
$mp/source-sh/7.2:

chdir\t\t$mp
complete\tfish cmd {-l help -d 'Command help'}
complete\tfish cmd {-s h -d 'Command help'}
complete\tfish cmd {-l version -d 'Command version'}
complete\tfish cmd {-s V -d 'Command version'}
complete\tfish mycmd {--exclusive -s h -d 'Command help'}
complete\tfish othercmd {-l version -d 'Command version'}
complete\tfish othercmd {-s V -d 'Command version'}
complete\tfish othercmd {--no-files -l help -d 'Command help'}
complete\tfish othercmd {--no-files -s h -d 'Command help'}
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.2
-------------------------------------------------------------------"
} else {
set tserr_disp72 "-------------------------------------------------------------------
$mp/source-sh/7.2:

chdir\t\t$mp
complete\tfish cmd {--long-option help --description 'Command help'}
complete\tfish cmd {--short-option 'h' --description 'Command help'}
complete\tfish cmd {--long-option version --description 'Command version'}
complete\tfish cmd {--short-option 'V' --description 'Command version'}
complete\tfish mycmd {--exclusive --short-option 'h' --description 'Command help'}
complete\tfish othercmd {--long-option version --description 'Command version'}
complete\tfish othercmd {--short-option 'V' --description 'Command version'}
complete\tfish othercmd {--no-files --long-option help --description 'Command help'}
complete\tfish othercmd {--no-files --short-option 'h' --description 'Command help'}
prepend-path\tFOOPATH /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHCB /path/to/dir1 /path/to/d\{r2 /path/to/dir3
prepend-path\tFOOPATHEM {} /path/to/dir1 /path/to/dir2 /path/to/dir3
prepend-path\tFOOPATHWC /path/to/dir1 /path/to/d\*r2 /path/to/dir3
setenv\t\tFOO value
setenv\t\tFOOCB va\{ue
setenv\t\tFOOEM {}
setenv\t\tFOOPATHSP {/path/to/dir1 /path/to/dir2 /path/to/dir3}
setenv\t\tFOOPATHSPEM {/path/to/dir1 /path/to/dir2 /path/to/dir3 }
setenv\t\tFOOSP {value }
setenv\t\tFOOWC va*ue
module-whatis\tsource-sh/7.2
-------------------------------------------------------------------"
}
# following tests are expected to fail with Tcl 9.0 (as of 9.0b1)
# similar stack trace than one reported at:
# https://core.tcl-lang.org/tcl/tktview/46dda6fc2904ee86cc45b3ddc14ce6fb6b4303e4
if {[cmpversion $tclsh_version 9.0] >= 0} {
    testouterr_cmd fish {display source-sh/7.2} OK $tserr_disp72 xfail
} else {
    testouterr_cmd fish {display source-sh/7.2} OK $tserr_disp72
}

unsetenv_loaded_module
unsetenv_var __MODULES_LMREFRESH
unsetenv_var __MODULES_LMSOURCESH
}

setenv_var TESTSUITE_SHTOMOD_NOCOMP 1
unsetenv_var TESTSUITE_SHTOMOD_NOALIAS
unsetenv_var TESTSUITE_SHTOMOD_NOFUNC


# test use of module command in script
setenv_path_var MODULEPATH $modpath:$modpath.2
setenv_var TESTSUITE_SHTOMOD_NOVAR 1
setenv_var TESTSUITE_SHTOMOD_NOPATH 1
setenv_var TESTSUITE_SHTOMOD_NOALIAS 1
setenv_var TESTSUITE_SHTOMOD_NOFUNC 1
setenv_var TESTSUITE_SHTOMOD_NOCD 1
setenv_var TESTSUITE_SHTOMOD_MODULE 1
# set things to trigger a module autoinit within test script in order to ensure
# module is defined, then cleanup not to report this setup within the environment
# changes made by the script
setenv_var MODULES_SET_SHELL_STARTUP 0
setenv_var MODULES_CMD [file normalize $env(TESTSUITEDIR)/../modulecmd.tcl]
setenv_var TCLSH $TCLSH

set lmsourceshpath {}
# setup simpler MANPATH value for tests if autoinit adds Modules man location to MANPATH
if {$install_setmanpath eq {y}} {
    set default_manpath /usr/share/man:/usr/local/share/man
    setenv_var MANPATH $default_manpath
    if {[string first { } $install_mandir] != -1} {
        set mandirenc "{$install_mandir}"
    } else {
        set mandirenc $install_mandir
    }
    if {$install_appendmanpath eq {y}} {
        set updatedmanpath $default_manpath:$install_mandir
        set lmsourceshpath "append-path MANPATH $mandirenc|"
    } else {
        set updatedmanpath $install_mandir:$default_manpath
        set lmsourceshpath "prepend-path MANPATH $mandirenc|"
    }
}
# setup PATH without Modules bin location
if {$install_setbinpath eq {y}} {
    set default_path [join [lsearch -all -inline -not [split $::env(PATH) :] $install_bindir] :]
    setenv_var PATH $default_path
    if {[string first { } $install_bindir] != -1} {
        set bindirenc "{$install_bindir}"
    } else {
        set bindirenc $install_bindir
    }
    if {$install_appendbinpath eq {y}} {
        set updatedpath $default_path:$install_bindir
        if {$install_appendmanpath eq {n}} {
            set lmsourceshpath "append-path PATH $bindirenc|$lmsourceshpath"
        } else {
            append lmsourceshpath "append-path PATH $bindirenc|"
        }
    } else {
        set updatedpath $install_bindir:$default_path
        append lmsourceshpath "prepend-path PATH $bindirenc|"
    }
}

set ans [list]
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION_STACK $install_version]
}
# MANPATH is set before PATH if the latter is appended and not the former
if {$install_setmanpath eq {y} && $install_appendbinpath eq {y} && $install_appendmanpath eq {n}} {
lappend ans [list set MANPATH $updatedmanpath]
}
if {$install_setbinpath eq {y}} {
lappend ans [list set PATH $updatedpath]
}
if {$install_setmanpath eq {y} && ($install_appendbinpath eq {n} || $install_appendmanpath eq {y})} {
lappend ans [list set MANPATH $updatedmanpath]
}
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set testsuite yes]
lappend ans [list set MODULES_COLLECTION_TARGET bar]
# if module was defined in environment prior test, the result of the source-sh evaluation
# will be the unset of the module functions
if {$is_modules_defined} {
    set extraans \|unset-function\ _module_raw\|unset-function\ ml\|unset-function\ module
} else {
    set extraans {}
}
if {$install_versioning eq {y}} {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULE_VERSION\ $install_version\|setenv\ MODULE_VERSION_STACK\ $install_version\|setenv\ MODULES_COLLECTION_TARGET\ bar\|setenv\ testsuite\ yes$extraans]
} else {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULES_COLLECTION_TARGET\ bar\|setenv\ testsuite\ yes$extraans]
}
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION $install_version]
}
if {$is_modules_defined} {
lappend ans [list {unset -f ml;}]
lappend ans [list {unset -f module;}]
lappend ans [list {unset -f _module_raw;}]
}
testouterr_cmd sh {load source-sh/1} $ans {}

if {$is_modules_defined} {
set extratserr "
unset-function\t_module_raw
unset-function\tml
unset-function\tmodule"
} else {
set extratserr {}
}

set tserr "-------------------------------------------------------------------
$mp/source-sh/1:\n\n"
set tserr_path {}
if {$install_setmanpath eq {y}} {
    if {$install_appendmanpath eq {y}} {
        append tserr_path "append-path\tMANPATH $mandirenc\n"
    } else {
        append tserr_path "prepend-path\tMANPATH $mandirenc\n"
    }
}
if {$install_setbinpath eq {y}} {
    if {$install_appendbinpath eq {y}} {
        if {$install_appendmanpath eq {n}} {
            set tserr_path "append-path\tPATH $bindirenc\n$tserr_path"
        } else {
            append tserr_path "append-path\tPATH $bindirenc\n"
        }
    } else {
        append tserr_path "prepend-path\tPATH $bindirenc\n"
    }
}
append tserr $tserr_path
if {$install_versioning eq {y}} {
    append tserr "setenv\t\tMODULE_VERSION $install_version
setenv\t\tMODULE_VERSION_STACK $install_version\n"
}
append tserr "setenv\t\tMODULES_COLLECTION_TARGET bar
setenv\t\ttestsuite yes$extratserr
module-whatis\tsource-sh/1
-------------------------------------------------------------------"
testouterr_cmd sh {display source-sh/1} OK $tserr

set tserr "$modlin
Module Specific Help for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesHelp in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {help source-sh/1} OK $tserr

set tserr "$modlin
Module Specific Test for $mpre/source-sh/1:

$warn_msgs: Unable to find ModulesTest in $mpre/source-sh/1.
$modlin"
testouterr_cmd_re sh {test source-sh/1} OK $tserr

# already set variable with equal or different value
setenv_var MODULES_COLLECTION_TARGET foo
setenv_var testsuite yes
set ans [list]
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION_STACK $install_version]
}
# MANPATH is set before PATH if the latter is appended and not the former
if {$install_setmanpath eq {y} && $install_appendbinpath eq {y} && $install_appendmanpath eq {n}} {
lappend ans [list set MANPATH $updatedmanpath]
}
if {$install_setbinpath eq {y}} {
lappend ans [list set PATH $updatedpath]
}
if {$install_setmanpath eq {y} && ($install_appendbinpath eq {n} || $install_appendmanpath eq {y})} {
lappend ans [list set MANPATH $updatedmanpath]
}
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set MODULES_COLLECTION_TARGET bar]
if {$install_versioning eq {y}} {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULE_VERSION\ $install_version\|setenv\ MODULE_VERSION_STACK\ $install_version\|setenv\ MODULES_COLLECTION_TARGET\ bar$extraans]
} else {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULES_COLLECTION_TARGET\ bar$extraans]
}
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION $install_version]
}
if {$is_modules_defined} {
lappend ans [list {unset -f ml;}]
lappend ans [list {unset -f module;}]
lappend ans [list {unset -f _module_raw;}]
}
testouterr_cmd sh {load source-sh/1} $ans {}

# module is loaded prior sh-to-mod
setenv_var testsuite no
setenv_loaded_module [list setenv/1.0] [list $modpath/setenv/1.0]
set ans [list]
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION_STACK $install_version]
}
# MANPATH is set before PATH if the latter is appended and not the former
if {$install_setmanpath eq {y} && $install_appendbinpath eq {y} && $install_appendmanpath eq {n}} {
lappend ans [list set MANPATH $updatedmanpath]
}
if {$install_setbinpath eq {y}} {
lappend ans [list set PATH $updatedpath]
}
if {$install_setmanpath eq {y} && ($install_appendbinpath eq {n} || $install_appendmanpath eq {y})} {
lappend ans [list set MANPATH $updatedmanpath]
}
lappend ans [list set _LMFILES_ $modpath/setenv/1.0:$mp/source-sh/1]
lappend ans [list set LOADEDMODULES setenv/1.0:source-sh/1]
lappend ans [list set MODULES_COLLECTION_TARGET bar]
if {$install_versioning eq {y}} {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULE_VERSION\ $install_version\|setenv\ MODULE_VERSION_STACK\ $install_version\|setenv\ MODULES_COLLECTION_TARGET\ bar$extraans]
} else {
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULES_COLLECTION_TARGET\ bar$extraans]
}
if {$install_versioning eq {y}} {
lappend ans [list set MODULE_VERSION $install_version]
}
if {$is_modules_defined} {
lappend ans [list {unset -f ml;}]
lappend ans [list {unset -f module;}]
lappend ans [list {unset -f _module_raw;}]
}
testouterr_cmd sh {load source-sh/1} $ans {}


setenv_loaded_module [list source-sh/1] [list $mp/source-sh/1]
setenv_var testsuite yes
setenv_var MODULES_COLLECTION_TARGET bar
if {$install_setbinpath eq {y}} {
setenv_var PATH $updatedpath
}
if {$install_setmanpath eq {y}} {
setenv_var MANPATH $updatedmanpath
}
setenv_var __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|${lmsourceshpath}setenv\ MODULES_COLLECTION_TARGET\ bar\|setenv\ testsuite\ yes
set ans [list]
# MANPATH is set before PATH if the latter is appended and not the former
if {$install_setmanpath eq {y} && $install_appendbinpath eq {y} && $install_appendmanpath eq {n}} {
lappend ans [list set MANPATH $default_manpath]
}
if {$install_setbinpath eq {y}} {
lappend ans [list set PATH $default_path]
}
if {$install_setmanpath eq {y} && ($install_appendbinpath eq {n} || $install_appendmanpath eq {y})} {
lappend ans [list set MANPATH $default_manpath]
}
lappend ans [list unset _LMFILES_]
lappend ans [list unset LOADEDMODULES]
lappend ans [list unset testsuite]
lappend ans [list unset MODULES_COLLECTION_TARGET]
lappend ans [list unset __MODULES_LMSOURCESH]
testouterr_cmd sh {unload source-sh/1} $ans {}
unsetenv_loaded_module
unsetenv_var __MODULES_LMSOURCESH
unsetenv_var MODULES_COLLECTION_TARGET
unsetenv_var testsuite
unsetenv_var TESTSUITE_SHTOMOD_MODULE
if {$install_setbinpath eq {y}} {
    setenv_var PATH $ORIG_PATH
}


# check excepted siteconfig file is installed
if {[siteconfig_isStderrTty]} {

# test removal of alias, function and completion from a source-sh script
setenv_var TESTSUITE_SHTOMOD_UNSETALFUNCCOMP 1

setenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHBASHUNSET 1
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/1]
lappend ans [list set LOADEDMODULES source-sh/1]
lappend ans [list set __MODULES_LMSOURCESH source-sh/1\&bash\ testsuite/example/sh-to-mod.sh\|uncomplete\ cmd\|unset-alias\ alfoo\|unset-function\ funcfoo]
lappend ans [list unalias alfoo]
lappend ans [list out {unset -f funcfoo;}]
lappend ans [list out {complete -r cmd;}]
testouterr_cmd bash {load source-sh/1} $ans {}
unsetenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHBASHUNSET

if {[find_bin tcsh] ne {}} {
setenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHTCSHUNSET 1
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/7.0]
lappend ans [list set LOADEDMODULES source-sh/7.0]
lappend ans [list set __MODULES_LMSOURCESH source-sh/7.0\&tcsh\ testsuite/example/sh-to-mod.csh\|uncomplete\ cmd\|unset-alias\ alfoo]
lappend ans [list unalias alfoo]
lappend ans [list out {uncomplete cmd;}]
testouterr_cmd tcsh {load source-sh/7.0} $ans {}
unsetenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHTCSHUNSET
}

if {[find_bin fish] ne {}} {
setenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHFISHUNSET 1
set ans [list]
lappend ans [list set _LMFILES_ $mp/source-sh/7.2]
lappend ans [list set LOADEDMODULES source-sh/7.2]
lappend ans [list set __MODULES_LMSOURCESH source-sh/7.2\&fish\ testsuite/example/sh-to-mod.fish\|uncomplete\ cmd\|unset-alias\ alfoo\|unset-function\ funcfoo]
lappend ans [list unalias alfoo]
lappend ans [list out {functions -e funcfoo;}]
lappend ans [list out {complete -e -c cmd;}]
testouterr_cmd fish {load source-sh/7.2} $ans {}
unsetenv_var TESTSUITE_ENABLE_SITECONFIG_SOURCESHFISHUNSET
}

unsetenv_var TESTSUITE_SHTOMOD_UNSETALFUNCCOMP

} elseif {$verbose > 0} {
    send_user "\tSkip tests relying on an excepted siteconfig file installed\n"
}


#
#  Cleanup
#

reset_test_env
